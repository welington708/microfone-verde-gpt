<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Gravação de Áudio</title>
</head>
<body>
  <h1>Teste de Gravação de Áudio</h1>
  <button id="btnGravar">🎙️ Gravar</button>
  <p id="status"></p>
  <p><strong>Resposta do Assistente:</strong></p>
  <pre id="resposta"></pre>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('btnGravar').onclick = async () => {
      const statusEl = document.getElementById('status');
      const respostaEl = document.getElementById('resposta');

      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
              audioChunks.push(event.data);
            }
          };

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const base64 = await blobToBase64(audioBlob);

            statusEl.textContent = '🎧 Enviando áudio para o Salesforce...';

            try {
              const response = await fetch('/services/apexrest/ChatGPTController/transcreverAudio', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ audioBase64: base64 }),
              });

              if (response.ok) {
                const data = await response.json();
                respostaEl.textContent = data.resultado || 'Sem resposta.';
                statusEl.textContent = '✅ Áudio processado!';
              } else {
                statusEl.textContent = '❌ Erro ao enviar áudio para o Salesforce.';
                respostaEl.textContent = await response.text();
              }
            } catch (error) {
              console.error(error);
              statusEl.textContent = '❌ Erro de rede ou servidor.';
            }
          };

          mediaRecorder.start();
          statusEl.textContent = '🔴 Gravando... (clique novamente para parar)';
        } catch (error) {
          console.error('Erro ao acessar o microfone:', error);
          alert('Não foi possível acessar o microfone.');
        }
      } else if (mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        statusEl.textContent = '⏳ Parando gravação...';
      }
    };

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
